@page "/"
@rendermode InteractiveServer
@inject IMenuService MenuService
@inject IHttpContextAccessor HttpContextAccessor
@using MenuModel = WhatTheDob.Domain.Entities.Menu

<PageTitle>Menu</PageTitle>

<h1>Menu</h1>

<section class="menu-filters">
    <div class="filter-group">
        <label for="dateInput">Date:</label>
        <input id="dateInput" type="date" @bind="_selectedDate" class="form-control" />
    </div>
    
    <div class="filter-group">
        <label for="campusSelect">Campus:</label>
        <select id="campusSelect" @bind="_selectedCampusId" class="form-select" disabled="@_isLoadingFilters">
            <option value="">-- Select Campus --</option>
            @foreach (var campus in _campuses)
            {
                <option value="@campus.Id">@campus.Value</option>
            }
        </select>
    </div>
    
    <div class="filter-group">
        <label for="mealSelect">Meal:</label>
        <select id="mealSelect" @bind="_selectedMealId" class="form-select" disabled="@_isLoadingFilters">
            <option value="">-- Select Meal --</option>
            @foreach (var meal in _meals)
            {
                <option value="@meal.Id">@meal.Value</option>
            }
        </select>
    </div>
    
    <div class="filter-group">
        <button type="button" @onclick="LoadMenuAsync" disabled="@(_isLoading || _isLoadingFilters)" class="btn btn-primary">
            @if (_isLoading)
            {
                <span>Loading...</span>
            }
            else
            {
                <span>Load Menu</span>
            }
        </button>
    </div>
</section>

@if (_isLoadingFilters)
{
    <p>Loading filters...</p>
}
else if (_isLoading)
{
    <p>Loading menu...</p>
}
else if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-danger">@_errorMessage</div>
}
else if (_menu is null)
{
    <p>Select a date, campus, and meal, then click "Load Menu" to view the menu.</p>
}
else
{

    <section class="menu-items">
        <h2>Items</h2>
        @if (_menu.Items.Count == 0)
        {
            <p>No items were returned for this menu.</p>
        }
        else
        {
            @foreach (var category in _menu.Items.GroupBy(item => item.Category).OrderBy(g => g.Key))
            {
                <div class="menu-category">
                    <h3 class="category-header">@category.Key</h3>
                    <ul class="menu-item-list">
                        @foreach (var item in category)
                        {
                            <li class="menu-item">
                                <h4>@item.Value</h4>
                                @if (item.Tags?.Count > 0)
                                {
                                    <p><strong>Tags:</strong> @string.Join(", ", item.Tags)</p>
                                }
                                <p><strong>Ratings:</strong> @(item.RatingCount == 0 ? "0" : ((double)item.TotalRating / item.RatingCount).ToString("0.0")) (Total) across @item.RatingCount vote(s)</p>
                                
                                <div class="star-rating">
                                    @{
                                        var displayRating = GetDisplayRating(item);
                                        var userRating = GetUserRating(item.Value);
                                        bool isUserRated = userRating > 0;
                                    }
                                    @for (int i = 5; i >= 1; i--)
                                    {
                                        var starIndex = i;
                                        var fillPercent = GetFillPercent(displayRating, starIndex);
                                        var isPartial = fillPercent > 0 && fillPercent < 100;
                                        var isFilled = fillPercent == 100;
                                        
                                        <button type="button" 
                                                class="star-button @(isUserRated && isFilled ? "user" : "") @(isFilled ? "filled" : "") @(isPartial ? "partial" : "")"
                                                style="@(isPartial ? $"--fill-percent: {fillPercent}%" : "")"
                                                @onclick="() => SubmitRating(item.Value, starIndex)"
                                                disabled="@_isSubmittingRating">
                                            â˜…
                                        </button>
                                    }
                                    @if (isUserRated)
                                    {
                                        <span class="user-rating-text">Your rating: @userRating</span>
                                    }
                                </div>
                            </li>
                        }
                    </ul>
                </div>
            }
        }
    </section>
}

@code {
    private MenuModel? _menu;
    private bool _isLoading = false;
    private bool _isLoadingFilters = true;
    private bool _isSubmittingRating = false;
    private string? _errorMessage;
    
    private List<Campus> _campuses = new();
    private List<Meal> _meals = new();
    
    private DateOnly _selectedDate = DateOnly.FromDateTime(DateTime.Now);
    private int? _selectedCampusId;
    private int? _selectedMealId;
    
    private Dictionary<string, int> _userRatings = new();
    private string? _sessionId;

    protected override async Task OnInitializedAsync()
    {
        _sessionId = HttpContextAccessor.HttpContext?.Request.Cookies["UserSessionId"];
        
        try
        {
            var campusesTask = MenuService.GetCampusesAsync();
            var mealsTask = MenuService.GetMealsAsync();
            
            await Task.WhenAll(campusesTask, mealsTask);
            
            _campuses = (await campusesTask).ToList();
            _meals = (await mealsTask).ToList();
            
            if (_campuses.Any())
            {
                _selectedCampusId = _campuses.First().Id;
            }
            
            if (_meals.Any())
            {
                _selectedMealId = _meals.First().Id;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load filters: {ex.Message}";
        }
        finally
        {
            _isLoadingFilters = false;
        }
    }
    
    private async Task LoadMenuAsync()
    {
        if (!_selectedCampusId.HasValue || !_selectedMealId.HasValue)
        {
            _errorMessage = "Please select both a campus and a meal.";
            StateHasChanged();
            return;
        }
        
        _isLoading = true;
        _errorMessage = null;   
        StateHasChanged();
        
        try
        {
            var formattedDate = _selectedDate.ToString("MM/dd/yy");
            
            _menu = await MenuService.GetMenuAsync(formattedDate, _selectedCampusId.Value, _selectedMealId.Value);
            
            if (_menu is null)
            {
                _errorMessage = "No menu found for the selected date, campus, and meal.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load menu: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task SubmitRating(string itemValue, int rating)
    {
        if (string.IsNullOrEmpty(_sessionId))
        {
            _errorMessage = "Session ID not found. Please refresh the page.";
            StateHasChanged();
            return;
        }
        
        _isSubmittingRating = true;
        StateHasChanged();
        
        try
        {
            await MenuService.SubmitUserRatingAsync(_sessionId, itemValue, rating);
            
            _userRatings[itemValue] = rating;
            
            if (_menu != null && _selectedCampusId.HasValue && _selectedMealId.HasValue)
            {
                var formattedDate = _selectedDate.ToString("MM/dd/yy");
                _menu = await MenuService.GetMenuAsync(formattedDate, _selectedCampusId.Value, _selectedMealId.Value);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to submit rating: {ex.Message}";
        }
        finally
        {
            _isSubmittingRating = false;
            StateHasChanged();
        }
    }
    
    private double GetDisplayRating(WhatTheDob.Domain.Entities.MenuItem item)
    {
        var userRating = GetUserRating(item.Value);
        if (userRating > 0)
        {
            return (double)userRating;
        }

        if (item.RatingCount == 0)
        {
            return 0;
        }
        
        return (double)item.TotalRating / item.RatingCount;
    }
    
    private int GetFillPercent(double rating, int starIndex)
    {
        if (rating >= starIndex) return 100;
        if (rating < starIndex - 1) return 0;
        
        // Example: rating 3.6. starIndex 4.
        // 3.6 < 4.  3.6 >= 3.
        // fill = 3.6 - 3 = 0.6 => 60%
        return (int)((rating - (starIndex - 1)) * 100);
    }

    private int GetUserRating(string itemValue)
    {
        return _userRatings.TryGetValue(itemValue, out var rating) ? rating : 0;
    }
}
