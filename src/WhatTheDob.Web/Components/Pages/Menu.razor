@page "/"
@rendermode InteractiveServer
@inject IMenuService MenuService
@inject IHttpContextAccessor HttpContextAccessor
@inject IJSRuntime JS
@inject IConfiguration Configuration
@using MenuModel = WhatTheDob.Domain.Entities.Menu

<PageTitle>Menu</PageTitle>

<section class="menu-filters card-style-lg">
    <div class="filter-group">
        <label for="dateInput">DATE</label>
        <input id="dateInput" type="date" @bind="_selectedDate" class="form-control" />
    </div>
    
    <div class="filter-group">
        <label for="campusSelect">CAMPUS</label>
        <select id="campusSelect" @bind="_selectedCampusId" class="form-select" disabled="@_isLoadingFilters">
            <option value="">-- Select Campus --</option>
            @foreach (var campus in _campuses)
            {
                <option value="@campus.Id">@FormatCampusName(campus.Value)</option>
            }
        </select>
    </div>
    
    <div class="filter-group">
        <label for="mealSelect">MEAL</label>
        <select id="mealSelect" @bind="_selectedMealId" class="form-select" disabled="@_isLoadingFilters">
            <option value="">-- Select Meal --</option>
            @foreach (var meal in _meals)
            {
                <option value="@meal.Id">@meal.Value</option>
            }
        </select>
    </div>
    <div class="filter-group">
        <button type="button" @onclick="LoadMenuAsync" disabled="@(_isLoading || _isLoadingFilters)" class="card-style-md">
            @if (_isLoading)
            {
                <span>Loading...</span>
            }
            else
            {
                <span>Load Menu</span>
            }
        </button>
    </div>
</section>

@if (_isLoadingFilters)
{
    <p>Loading filters...</p>
}
else if (_isLoading)
{
    <p>Loading menu...</p>
}
else if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-danger">@_errorMessage</div>
}
else if (_menu is null)
{
    <p>Select a date, campus, and meal, then click "Load Menu" to view the menu.</p>
}
else
{

    <section class="menu-items">
        @if (_menu.Items.Count == 0)
        {
            <p>No items were returned for this menu.</p>
        }
        else
        {
            var categoryIndex = 0;
            @foreach (var category in _menu.Items.GroupBy(item => item.Category).OrderBy(g => g.Key))
            {
                var colorIndex = categoryIndex % 8;
                <div class="menu-category">
                    <h3 class="category-header">@category.Key</h3>
                    <ul class="menu-item-list">
                        @foreach (var item in category)
                        {
                            <li class="menu-item card-style-lg">
                                <div class="menu-item-header iterable-color-@colorIndex">
                                    <h4>@item.Value</h4>
                                </div>
                                
                                <div class="star-rating">
                                    @{
                                        var displayRating = GetDisplayRating(item);
                                        var userRating = GetUserRating(item.Value);
                                        bool isUserRated = userRating > 0;
                                    }
                                    @for (int i = 5; i >= 1; i--)
                                    {
                                        var starIndex = i;
                                        var fillPercent = GetFillPercent(displayRating, starIndex);
                                        var isPartial = fillPercent > 0 && fillPercent < 100;
                                        var isFilled = fillPercent == 100;

                                        <button type="button"
                                                class="star-button @(isUserRated && isFilled ? "user" : "") @(isFilled ? "filled" : "") @(isPartial ? "partial" : "")"
                                                style="@(isPartial ? $"--fill-percent: {fillPercent}%" : "")"
                                                @onclick="() => SubmitRating(item.Value, starIndex)"
                                                disabled="@_isSubmittingRating">
                                        </button>
                                    }
                                </div>
                                <div class="rating-info">
                                    <div class="line"></div>
                                    <p>@(item.RatingCount == 0 ? "0.0" : ((double)item.TotalRating / item.RatingCount).ToString("0.0"))/5 (@item.RatingCount rating@(item.RatingCount == 0 ? "" : "s"))</p>
                                </div>
                                @if (item.Tags?.Count > 0)
                                {
                                    <div class="tags-list">
                                        @foreach (var tag in item.Tags.SelectMany(t => t.Split(',')).Select(t => t.Trim()).Where(t => !string.IsNullOrEmpty(t)))
                                        {
                                            <span class="tag-item" title="@tag">@GetTagShortName(tag)</span>
                                        }
                                    </div>
                                }
                            </li>
                        }
                    </ul>
                </div>
                categoryIndex++;
            }
        }
    </section>
}

@code {
    private MenuModel? _menu;
    private bool _isLoading = false;
    private bool _isLoadingFilters = true;
    private bool _isSubmittingRating = false;
    private string? _errorMessage;
    
    private List<Campus> _campuses = new();
    private List<Meal> _meals = new();
    
    private DateOnly _selectedDate = DateOnly.FromDateTime(DateTime.Now);
    private int? _selectedCampusId;
    private int? _selectedMealId;
    
    private Dictionary<string, int> _userRatings = new();
    private Dictionary<string, string> _tagMappings = new();
    private string? _sessionId;
    private const string RatingCookiePrefix = "wtd-ur-"; // user rating cookie prefix

    protected override async Task OnInitializedAsync()
    {
        _tagMappings = Configuration.GetSection("TagMappings").Get<Dictionary<string, string>>() ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

        _sessionId = HttpContextAccessor.HttpContext?.Request.Cookies["UserSessionId"];
        LoadUserRatingsFromCookies();
        
        try
        {
            var campusesTask = MenuService.GetCampusesAsync();
            var mealsTask = MenuService.GetMealsAsync();
            
            await Task.WhenAll(campusesTask, mealsTask);
            
            _campuses = (await campusesTask).ToList();
            _meals = (await mealsTask).ToList();
            
            if (_campuses.Any())
            {
                _selectedCampusId = _campuses.First().Id;
            }
            
            if (_meals.Any())
            {
                _selectedMealId = _meals.First().Id;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load filters: {ex.Message}";
        }
        finally
        {
            _isLoadingFilters = false;
        }
    }
    
    private async Task LoadMenuAsync()
    {
        if (!_selectedCampusId.HasValue || !_selectedMealId.HasValue)
        {
            _errorMessage = "Please select both a campus and a meal.";
            StateHasChanged();
            return;
        }
        
        _isLoading = true;
        _errorMessage = null;   
        StateHasChanged();
        
        try
        {
            var formattedDate = _selectedDate.ToString("MM/dd/yy");
            
            _menu = await MenuService.GetMenuAsync(formattedDate, _selectedCampusId.Value, _selectedMealId.Value);
            
            if (_menu is null)
            {
                _errorMessage = "No menu found for the selected date, campus, and meal.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load menu: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task SubmitRating(string itemValue, int rating)
    {
        if (string.IsNullOrEmpty(_sessionId))
        {
            _errorMessage = "Session ID not found. Please refresh the page.";
            StateHasChanged();
            return;
        }
        
        _isSubmittingRating = true;
        StateHasChanged();
        
        try
        {
            await MenuService.SubmitUserRatingAsync(_sessionId, itemValue, rating);
            
            _userRatings[itemValue] = rating;
            SaveUserRatingToCookies(itemValue, rating);
            CleanupMismatchedRatingCookies();
            
            if (_menu != null && _selectedCampusId.HasValue && _selectedMealId.HasValue)
            {
                var formattedDate = _selectedDate.ToString("MM/dd/yy");
                _menu = await MenuService.GetMenuAsync(formattedDate, _selectedCampusId.Value, _selectedMealId.Value);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to submit rating: {ex.Message}";
        }
        finally
        {
            _isSubmittingRating = false;
            StateHasChanged();
        }
    }
    
    private double GetDisplayRating(WhatTheDob.Domain.Entities.MenuItem item)
    {
        var userRating = GetUserRating(item.Value);
        if (userRating > 0)
        {
            return (double)userRating;
        }

        if (item.RatingCount == 0)
        {
            return 0;
        }
        
        return (double)item.TotalRating / item.RatingCount;
    }
    
    private int GetFillPercent(double rating, int starIndex)
    {
        if (rating >= starIndex) return 100;
        if (rating < starIndex - 1) return 0;
        
        // Example: rating 3.6. starIndex 4.
        // 3.6 < 4.  3.6 >= 3.
        // fill = 3.6 - 3 = 0.6 => 60%
        return (int)((rating - (starIndex - 1)) * 100);
    }

    private int GetUserRating(string itemValue)
    {
        return _userRatings.TryGetValue(itemValue, out var rating) ? rating : 0;
    }

    private void LoadUserRatingsFromCookies()
    {
        var context = HttpContextAccessor.HttpContext;
        if (context == null) return;

        var reqCookies = context.Request.Cookies;
        foreach (var kvp in reqCookies)
        {
            // Ignore non rating cookies
            var key = kvp.Key;
            if (!key.StartsWith(RatingCookiePrefix, StringComparison.Ordinal)) continue;

            // Ignore empty rating cookies
            var raw = kvp.Value;
            if (string.IsNullOrEmpty(raw)) continue;

            var parts = raw.Split(':', 2);
            if (parts.Length != 2) { DeleteCookie(key); continue; }

            var cookieSessionId = parts[0];
            if (string.IsNullOrEmpty(cookieSessionId) || cookieSessionId != _sessionId)
            {
                // Remove ratings for other sessions
                DeleteCookie(key);
                continue;
            }

            // Remove any irregular cookies
            if (!int.TryParse(parts[1], out var rating) || rating < 1 || rating > 5)
            {
                DeleteCookie(key);
                continue;
            }

            // Decode that b
            var encodedItemValue = key.Substring(RatingCookiePrefix.Length);
            var itemValue = System.Net.WebUtility.UrlDecode(encodedItemValue);
            if (string.IsNullOrWhiteSpace(itemValue)) { DeleteCookie(key); continue; }

            _userRatings[itemValue] = rating;
        }
    }

    private void SaveUserRatingToCookies(string itemValue, int rating)
    {
        var context = HttpContextAccessor.HttpContext;
        if (string.IsNullOrEmpty(_sessionId)) return;

        var encodedItemValue = System.Net.WebUtility.UrlEncode(itemValue);
        var key = RatingCookiePrefix + encodedItemValue;
        var value = _sessionId + ":" + rating;

        // Write cookie client-side
        var isHttps = context?.Request?.IsHttps == true;
        var secureFlag = isHttps ? "Secure; " : string.Empty;
        var cookieString = $"{key}={value}; {secureFlag}SameSite=Lax; Path=/; Max-Age={(int)TimeSpan.FromDays(7).TotalSeconds}";
        // Possibly look into better sanitization if issues arise
        JS.InvokeVoidAsync("eval", $"document.cookie = '{cookieString.Replace("'", "\\'")}'");
    }

    // Removes any old cookies that don't match the current session ID
    private void CleanupMismatchedRatingCookies()
    {
        var context = HttpContextAccessor.HttpContext;
        if (context == null) return;

        foreach (var kvp in context.Request.Cookies)
        {
            var key = kvp.Key;
            if (!key.StartsWith(RatingCookiePrefix, StringComparison.Ordinal)) continue;

            var raw = kvp.Value;

            if (string.IsNullOrEmpty(raw))
            {
                DeleteCookie(key);
                continue;
            }

            var parts = raw.Split(':', 2);
            if (parts.Length != 2 || parts[0] != _sessionId)
            {
                DeleteCookie(key);
            }
        }
    }

    private string FormatCampusName(string campusName)
    {
        if (string.IsNullOrEmpty(campusName))
            return campusName;

        if (campusName.Contains(" - "))
        {
            return campusName.Replace(" - ", ": ");
        }

        if (campusName.Contains("@"))
        {
            var colonIndex = campusName.IndexOf(':');
            var atIndex = campusName.IndexOf('@');

            if (colonIndex > -1 && atIndex > colonIndex)
            {
                var prefix = campusName.Substring(0, colonIndex);
                var suffix = campusName.Substring(atIndex + 1).Trim();
                return $"{prefix}: {suffix}";
            }
        }

        return campusName;
    }

    private string GetTagShortName(string tag)
    {
        return _tagMappings.TryGetValue(tag, out var shortName) ? shortName : tag;
    }

    // May not run post server-side render, maybe run through js interop if it becomes a problem
    private void DeleteCookie(string key)
    {
        var context = HttpContextAccessor.HttpContext;
        if (context == null) return;
        context.Response.Cookies.Delete(key);
    }
}
