@page "/"
@rendermode InteractiveServer
@using MenuModel = WhatTheDob.Domain.Entities.Menu

<PageTitle>Menu</PageTitle>

<section class="menu-filters card-style-lg">
    <div class="filter-group">
        <label for="dateInput">DATE</label>
        <input id="dateInput" type="date" @bind="_selectedDate" class="form-control" />
    </div>
    
    <div class="filter-group">
        <label for="campusSelect">CAMPUS</label>
        <select id="campusSelect" @bind="_selectedCampusId" class="form-select" disabled="@_isLoadingFilters">
            <option value="">-- Select Campus --</option>
            @foreach (var campus in _campuses)
            {
                <option value="@campus.Id">@FormatCampusName(campus.Value)</option>
            }
        </select>
    </div>
    
    <div class="filter-group">
        <label for="mealSelect">MEAL</label>
        <select id="mealSelect" @bind="_selectedMealId" class="form-select" disabled="@_isLoadingFilters">
            <option value="">-- Select Meal --</option>
            @foreach (var meal in _meals)
            {
                <option value="@meal.Id">@meal.Value</option>
            }
        </select>
    </div>
    <div class="filter-group">
        <button type="button" @onclick="LoadMenuAsync" disabled="@(_isLoading || _isLoadingFilters)" class="card-style-md">
            @if (_isLoading)
            {
                <span>Loading...</span>
            }
            else
            {
                <span>Load Menu</span>
            }
        </button>
    </div>
</section>

@if (_isLoadingFilters)
{
    <p>Loading filters...</p>
}
else if (_isLoading)
{
    <p>Loading menu...</p>
}
else if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-danger">@_errorMessage</div>
}
else if (_menu is null)
{
    <p>Select a date, campus, and meal, then click "Load Menu" to view the menu.</p>
}
else
{

    <section class="menu-items">
        @if (_menu.Items.Count == 0)
        {
            <p>No items were returned for this menu.</p>
        }
        else
        {
            var categoryIndex = 0;
            @foreach (var category in _menu.Items.GroupBy(item => item.Category).OrderBy(g => g.Key))
            {
                var colorIndex = categoryIndex % 8;
                <div class="menu-category">
                    <h3 class="category-header">@category.Key</h3>
                    <ul class="menu-item-list">
                        @foreach (var item in category)
                        {
                            <li class="menu-item card-style-lg">
                                <div class="menu-item-header iterable-color-@colorIndex">
                                    <h4>@item.Value</h4>
                                </div>
                                
                                <div class="star-rating">
                                    @{
                                        var displayRating = GetDisplayRating(item);
                                        var userRating = GetUserRating(item.Value);
                                        bool isUserRated = userRating > 0;
                                    }
                                    @for (int i = 5; i >= 1; i--)
                                    {
                                        var starIndex = i;
                                        var fillPercent = GetFillPercent(displayRating, starIndex);
                                        var isPartial = fillPercent > 0 && fillPercent < 100;
                                        var isFilled = fillPercent == 100;

                                        <button type="button"
                                                class="star-button @(isUserRated && isFilled ? "user" : "") @(isFilled ? "filled" : "") @(isPartial ? "partial" : "")"
                                                style="@(isPartial ? $"--fill-percent: {fillPercent}%" : "")"
                                                @onclick="() => SubmitRating(item.Value, starIndex)"
                                                disabled="@_isSubmittingRating"
                                                aria-label="Rate @starIndex out of 5"
                                                title="Rate @starIndex out of 5">
                                        </button>
                                    }
                                </div>
                                <div class="rating-info">
                                    <div class="line"></div>
                                    <p>@(item.RatingCount == 0 ? "0.0" : ((double)item.TotalRating / item.RatingCount).ToString("0.0"))/5 (@item.RatingCount rating@(item.RatingCount == 1 ? "" : "s"))</p>
                                </div>
                                @if (item.Tags?.Count > 0)
                                {
                                    <div class="tags-list">
                                        @foreach (var tag in item.Tags.SelectMany(t => t.Split(',')).Select(t => t.Trim()).Where(t => !string.IsNullOrEmpty(t)))
                                        {
                                            <span class="tag-item" title="@tag">@GetTagShortName(tag)</span>
                                        }
                                    </div>
                                }
                            </li>
                        }
                    </ul>
                </div>
                categoryIndex++;
            }
        }
    </section>
}
